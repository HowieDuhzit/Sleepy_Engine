services:
  game:
    image: ghcr.io/howieduhzit/sleepy_engine:main
    container_name: sleepyengine
    restart: unless-stopped

    environment:
      # Production environment
      NODE_ENV: production

      # Server configuration paths
      PROJECTS_DIR: /app/projects

      # Coolify magic variable for the service URL
      # This will be auto-populated by Coolify with the assigned domain
      APP_URL: ${SERVICE_FQDN_GAME_80}

      # Database (Postgres)
      DATABASE_URL: postgres://sleepy:sleepy@db:5432/sleepy_engine
      # Redis (optional)
      REDIS_URL: redis://redis:6379

    volumes:
      # Persistent storage for projects
      - game-projects:/app/projects

      # Persistent storage for any runtime data
      - game-data:/app/data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    labels:
      # Coolify labels for service management
      coolify.managed: "true"

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: sleepy
      POSTGRES_PASSWORD: sleepy
      POSTGRES_DB: sleepy_engine
    volumes:
      - game-db:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - game-redis:/data

volumes:
  game-projects:
    driver: local
  game-data:
    driver: local
  game-db:
    driver: local
  game-redis:
    driver: local
